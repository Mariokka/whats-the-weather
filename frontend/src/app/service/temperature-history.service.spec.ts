import { TestBed } from '@angular/core/testing';

import {
  HttpClientTestingModule,
  HttpTestingController,
} from '@angular/common/http/testing';
import {
  TemperatureHistoryService, WeatherDto,
} from './temperature-history.service';

describe('TemperatureHistoryService', () => {
  let service: TemperatureHistoryService;
  let controller: HttpTestingController;

  let startDate: Date = new Date("2023-07-23T00:00");
  let endDate: Date = new Date("2023-08-06T00:00");

  beforeEach(() => {
    TestBed.configureTestingModule({
      imports: [HttpClientTestingModule],
    });
    service = TestBed.inject(TemperatureHistoryService);
    controller = TestBed.inject(HttpTestingController);
  });

  it('creates', () => {
    expect(service).toBeTruthy();
  });

  it('is able to connect to endpoint', () => {
    //given
    service.requestTemperature(startDate, endDate).subscribe((value) => {
      expect(JSON.stringify(value)).toContain(endDate.getTime().toString().substring(0, 10));
    });

    controller
      .expectOne((req) => {
        return (
          req.method === 'GET' &&
          req.url === `https://archive-api.open-meteo.com/v1/archive?latitude=53.5507&longitude=9.993&start_date=${startDate.toISOString().split('T')[0]}&end_date=${endDate.toISOString().split('T')[0]}&hourly=temperature_2m,rain`
        );
      })
      .flush({"latitude":53.600006,"longitude":10.0,"generationtime_ms":0.3629922866821289,"utc_offset_seconds":0,"timezone":"GMT","timezone_abbreviation":"GMT","elevation":11.0,"hourly_units":{"time":"unixtime","temperature_2m":"Â°C","rain":"mm"},"hourly":{"time":[1690070400,1690074000,1690077600,1690081200,1690084800,1690088400,1690092000,1690095600,1690099200,1690102800,1690106400,1690110000,1690113600,1690117200,1690120800,1690124400,1690128000,1690131600,1690135200,1690138800,1690142400,1690146000,1690149600,1690153200,1690156800,1690160400,1690164000,1690167600,1690171200,1690174800,1690178400,1690182000,1690185600,1690189200,1690192800,1690196400,1690200000,1690203600,1690207200,1690210800,1690214400,1690218000,1690221600,1690225200,1690228800,1690232400,1690236000,1690239600,1690243200,1690246800,1690250400,1690254000,1690257600,1690261200,1690264800,1690268400,1690272000,1690275600,1690279200,1690282800,1690286400,1690290000,1690293600,1690297200,1690300800,1690304400,1690308000,1690311600,1690315200,1690318800,1690322400,1690326000,1690329600,1690333200,1690336800,1690340400,1690344000,1690347600,1690351200,1690354800,1690358400,1690362000,1690365600,1690369200,1690372800,1690376400,1690380000,1690383600,1690387200,1690390800,1690394400,1690398000,1690401600,1690405200,1690408800,1690412400,1690416000,1690419600,1690423200,1690426800,1690430400,1690434000,1690437600,1690441200,1690444800,1690448400,1690452000,1690455600,1690459200,1690462800,1690466400,1690470000,1690473600,1690477200,1690480800,1690484400,1690488000,1690491600,1690495200,1690498800,1690502400,1690506000,1690509600,1690513200,1690516800,1690520400,1690524000,1690527600,1690531200,1690534800,1690538400,1690542000,1690545600,1690549200,1690552800,1690556400,1690560000,1690563600,1690567200,1690570800,1690574400,1690578000,1690581600,1690585200,1690588800,1690592400,1690596000,1690599600,1690603200,1690606800,1690610400,1690614000,1690617600,1690621200,1690624800,1690628400,1690632000,1690635600,1690639200,1690642800,1690646400,1690650000,1690653600,1690657200,1690660800,1690664400,1690668000,1690671600,1690675200,1690678800,1690682400,1690686000,1690689600,1690693200,1690696800,1690700400,1690704000,1690707600,1690711200,1690714800,1690718400,1690722000,1690725600,1690729200,1690732800,1690736400,1690740000,1690743600,1690747200,1690750800,1690754400,1690758000,1690761600,1690765200,1690768800,1690772400,1690776000,1690779600,1690783200,1690786800,1690790400,1690794000,1690797600,1690801200,1690804800,1690808400,1690812000,1690815600,1690819200,1690822800,1690826400,1690830000,1690833600,1690837200,1690840800,1690844400,1690848000,1690851600,1690855200,1690858800,1690862400,1690866000,1690869600,1690873200,1690876800,1690880400,1690884000,1690887600,1690891200,1690894800,1690898400,1690902000,1690905600,1690909200,1690912800,1690916400,1690920000,1690923600,1690927200,1690930800,1690934400,1690938000,1690941600,1690945200,1690948800,1690952400,1690956000,1690959600,1690963200,1690966800,1690970400,1690974000,1690977600,1690981200,1690984800,1690988400,1690992000,1690995600,1690999200,1691002800,1691006400,1691010000,1691013600,1691017200,1691020800,1691024400,1691028000,1691031600,1691035200,1691038800,1691042400,1691046000,1691049600,1691053200,1691056800,1691060400,1691064000,1691067600,1691071200,1691074800,1691078400,1691082000,1691085600,1691089200,1691092800,1691096400,1691100000,1691103600,1691107200,1691110800,1691114400,1691118000,1691121600,1691125200,1691128800,1691132400,1691136000,1691139600,1691143200,1691146800,1691150400,1691154000,1691157600,1691161200,1691164800,1691168400,1691172000,1691175600,1691179200,1691182800,1691186400,1691190000,1691193600,1691197200,1691200800,1691204400,1691208000,1691211600,1691215200,1691218800,1691222400,1691226000,1691229600,1691233200,1691236800,1691240400,1691244000,1691247600,1691251200,1691254800,1691258400,1691262000,1691265600,1691269200,1691272800,1691276400,1691280000,1691283600,1691287200,1691290800,1691294400,1691298000,1691301600,1691305200,1691308800,1691312400,1691316000,1691319600,1691323200,1691326800,1691330400,1691334000,1691337600,1691341200,1691344800,1691348400,1691352000,1691355600,1691359200,1691362800],"temperature_2m":[14.7,14.6,14.6,14.7,14.7,14.7,14.8,15.3,15.6,16.0,16.6,17.1,16.9,16.7,16.6,16.7,17.2,17.4,17.8,17.5,17.5,17.4,17.4,17.5,17.3,17.0,16.8,16.6,16.5,16.9,17.7,18.6,19.0,19.3,19.0,18.9,19.7,20.7,21.4,21.6,20.2,18.8,18.3,16.6,16.1,15.5,15.0,14.7,14.2,13.9,13.6,13.5,13.1,13.5,14.2,15.7,16.5,17.7,18.4,18.8,18.9,19.0,18.8,18.5,18.1,17.4,16.6,15.7,15.0,14.4,13.8,13.5,13.4,13.1,13.0,12.8,12.7,13.0,13.6,13.9,14.8,16.0,16.7,17.1,17.9,18.1,18.5,17.7,16.2,16.0,15.9,15.1,14.3,13.9,13.6,13.3,12.9,12.7,12.5,12.1,11.9,12.7,14.2,15.1,15.7,16.5,16.5,16.9,17.7,18.0,17.6,17.1,16.8,16.6,16.3,16.6,15.7,15.7,15.6,15.4,15.3,15.2,15.1,15.2,15.4,15.7,16.0,16.5,17.3,18.3,19.0,19.3,19.4,20.1,20.8,21.5,21.5,20.5,20.2,19.7,18.3,17.3,16.5,16.0,15.5,15.3,15.1,15.4,15.9,16.5,17.7,18.8,19.4,20.1,20.5,21.3,21.9,22.6,22.6,21.3,19.9,18.5,18.2,17.9,17.2,16.7,16.3,16.0,16.0,15.7,15.7,15.4,15.2,15.4,16.4,17.5,18.8,19.7,20.0,19.9,20.3,20.3,20.5,17.0,17.8,17.9,17.4,16.7,16.2,15.8,15.4,15.0,14.9,14.7,14.7,14.6,14.9,15.1,15.3,15.0,15.4,16.1,16.7,16.3,16.5,16.8,17.1,17.5,18.0,17.6,17.6,17.5,16.9,16.8,16.6,16.3,16.4,16.3,16.1,16.0,15.7,15.7,16.0,16.2,16.2,17.4,19.2,17.4,17.4,17.1,17.8,18.4,16.9,16.6,16.3,16.0,15.7,15.5,15.4,15.5,15.5,15.4,15.2,15.1,15.0,15.1,15.6,16.4,17.4,18.4,19.7,19.7,19.0,18.4,18.0,17.5,17.5,17.5,17.9,17.7,17.0,16.7,16.2,16.0,15.6,15.6,15.7,15.5,15.3,15.5,15.3,15.4,15.6,16.0,16.6,17.3,18.4,19.8,20.3,20.2,18.5,18.0,17.8,17.3,16.8,16.4,16.2,15.9,15.6,15.1,15.0,14.9,15.2,15.3,15.9,16.6,17.8,18.8,19.1,20.0,20.6,19.5,19.0,19.5,19.5,19.2,18.4,17.1,16.1,15.2,14.3,13.5,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null],"rain":[0.90,0.50,0.10,0.10,0.10,0.20,0.40,1.00,0.80,0.40,0.40,0.70,0.80,0.40,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.10,0.10,0.50,1.40,1.00,0.40,0.00,0.00,0.10,1.80,1.70,0.10,0.40,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.00,0.00,0.00,0.00,0.00,0.10,0.00,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.20,0.00,0.10,0.10,0.10,0.00,0.00,0.10,0.10,1.80,3.90,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.20,0.30,0.30,0.30,0.20,0.10,0.20,0.10,0.50,1.10,0.70,0.70,1.40,1.40,0.30,0.20,1.10,0.50,0.50,0.70,0.60,0.40,0.10,0.10,0.10,0.20,0.10,0.20,0.10,0.10,0.00,0.00,0.00,0.30,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.20,0.10,0.00,0.00,0.00,0.10,0.10,0.10,0.20,0.20,0.10,0.30,2.20,2.10,0.10,2.80,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.10,0.20,0.00,0.00,2.70,0.20,0.00,0.00,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.20,0.60,2.20,0.80,0.30,0.30,0.90,0.70,0.30,0.20,0.20,0.10,0.40,0.10,0.10,0.90,2.40,4.20,4.50,2.60,0.80,0.00,0.00,0.20,0.10,0.10,0.50,0.10,0.10,0.20,3.10,0.80,1.20,0.20,0.20,2.10,0.50,0.20,0.20,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.30,0.10,0.00,0.10,0.50,0.70,1.40,1.20,0.40,0.20,0.10,0.00,0.10,0.40,0.00,0.00,1.00,0.40,1.10,0.30,0.30,0.10,0.40,0.40,1.00,0.90,1.00,0.50,0.70,0.20,0.90,0.60,1.30,1.20,0.20,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.00,0.10,0.10,0.10,0.10,0.10,0.10,0.20,2.10,0.40,0.10,0.10,0.00,0.00,0.00,0.00,0.00,0.00,0.00,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null]}});
  });
});
